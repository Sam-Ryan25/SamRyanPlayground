name: Release notes to Zapier

on:
  workflow_dispatch:
    inputs:
      days:
        description: "Number of days back to include releases"
        required: false
        default: "30"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install axios openai

      - name: Collect, Clean, and Send Notes to Zapier
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DAYS: ${{ github.event.inputs.days }}
          ZAPIER_WEBHOOK_URL: ${{ secrets.ZAPIER_WEBHOOK_URL }}
        run: |
          node <<'EOF'
          const axios = require('axios');
          const OpenAI = require('openai');

          const days = parseInt(process.env.DAYS || "30", 10);
          const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
          const webhookUrl = process.env.ZAPIER_WEBHOOK_URL;

          async function run() {
            console.log("üì¶ Fetching GitHub releases...");
            const releases = await axios.get(
              "https://api.github.com/repos/${{ github.repository }}/releases",
              { headers: { Authorization: `token ${process.env.GITHUB_TOKEN}` } }
            );

            const recent = releases.data.filter(r => new Date(r.published_at) >= cutoff);
            if (!recent.length) {
              console.log("‚ÑπÔ∏è No recent releases found in timeframe.");
              return;
            }

            const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
            let combinedContent = "";

            for (const r of recent) {
              let content = r.body || "";

              // --- Clean release notes ---
              content = content.replace(/## What's Changed/g, '');
              content = content.replace(/## New Contributors[\s\S]*/g, '');
              content = content.replace(/Full Changelog:.*$/gm, '');
              content = content.replace(/ by @\S+/g, '');
              content = content.replace(/https:\/\/github\.com\/\S+/g, '');

              let lines = content.split('\n').map(l => l.trim()).filter(Boolean);
              if (!lines.length) continue;

              console.log(`ü§ñ Sending ${lines.length} bullets to OpenAI...`);

              const response = await openai.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [
                  {
                    role: "system",
                    content: "You are a marketing assistant rewriting release note bullet points for end users. Keep them concise, friendly, and non-technical. Return one bullet per line, no markdown."
                  },
                  { role: "user", content: lines.join("\n") }
                ],
                temperature: 0.3,
                max_tokens: 1000,
              });

              const cleaned = response.choices[0].message.content
                .split("\n")
                .map(l => l.trim())
                .filter(Boolean);

              const section = {
                title: r.name || r.tag_name,
                date: r.published_at.slice(0,10),
                bullets: cleaned
              };

              combinedContent += JSON.stringify(section) + "\n";
            }

            console.log("üìù Sending cleaned release notes to Zapier...");
            await axios.post(webhookUrl, {
              workspace: "${{ secrets.LOOPEDIN_WORKSPACE_ID }}",
              title: `Release Notes (Last ${days} Days)`,
              content: combinedContent
            });

            console.log("‚úÖ Sent to Zapier successfully!");
          }

          run().catch(err => {
            console.error("‚ùå Failed:", err.response?.data || err.message || err);
            process.exit(1);
          });
          EOF

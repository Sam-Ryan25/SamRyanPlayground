name: Release notes summary with llm

on:
  workflow_dispatch:
    inputs:
      days:
        description: "Number of days back to include releases"
        required: false
        default: "30"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm install axios openai

      - name: Collect, Clean, and Publish Notes to LoopedIn
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LOOPEDIN_API_KEY: ${{ secrets.LOOPEDIN_API_KEY }}
          LOOPEDIN_WORKSPACE_ID: ${{ secrets.LOOPEDIN_WORKSPACE_ID }}
          DAYS: ${{ github.event.inputs.days }}
        run: |
          node <<'EOF'
          const axios = require('axios');
          const OpenAI = require('openai');

          const days = parseInt(process.env.DAYS || "30", 10);
          const cutoff = new Date(Date.now() - days * 24 * 60 * 60 * 1000);

          const workspaceId = process.env.LOOPEDIN_WORKSPACE_ID.trim();
          const loopedinApiKey = process.env.LOOPEDIN_API_KEY.trim();

          async function run() {
            // --- Verify API key and workspace first ---
            try {
              console.log("üîë Checking LoopedIn API key and workspace access...");
              const check = await axios.get(
                `https://api.loopedin.io/v1/workspaces/${workspaceId}`,
                { headers: { "x-loopedin-key": loopedinApiKey } }
              );
              console.log("‚úÖ Workspace access OK:", check.data.name || "Workspace found");
            } catch (err) {
              console.error("‚ùå Unauthorized or invalid workspace/API key:", err.response?.data || err.message);
              process.exit(1);
            }

            console.log("üì¶ Fetching GitHub releases...");
            const releases = await axios.get(
              "https://api.github.com/repos/${{ github.repository }}/releases",
              { headers: { Authorization: `token ${process.env.GITHUB_TOKEN}` } }
            );

            const recent = releases.data.filter(r => new Date(r.published_at) >= cutoff);

            if (!recent.length) {
              console.log("‚ÑπÔ∏è No recent releases found in timeframe.");
              return;
            }

            const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
            let combinedContent = "";

            for (const r of recent) {
              let content = r.body || "";

              content = content.replace(/## What's Changed/g, '');
              content = content.replace(/## New Contributors[\s\S]*/g, '');
              content = content.replace(/Full Changelog:.*$/gm, '');
              content = content.replace(/ by @\S+/g, '');
              content = content.replace(/https:\/\/github\.com\/\S+/g, '');

              let lines = content.split('\n').map(l => l.trim()).filter(Boolean);
              if (!lines.length) continue;

              console.log(`ü§ñ Sending ${lines.length} bullets to OpenAI for cleanup...`);

              const response = await openai.chat.completions.create({
                model: "gpt-4o-mini",
                messages: [
                  {
                    role: "system",
                    content: "You are a marketing assistant rewriting release note bullet points for end users. Keep them concise, friendly, and non-technical. Return one bullet per line, no markdown."
                  },
                  { role: "user", content: lines.join("\n") }
                ],
                temperature: 0.3,
                max_tokens: 1000,
              });

              const cleaned = response.choices[0].message.content
                .split("\n")
                .map(l => l.trim())
                .filter(Boolean);

              const section = `
                <h2>${r.name || r.tag_name} (${r.published_at.slice(0,10)})</h2>
                <ul>${cleaned.map(line => `<li>${line}</li>`).join('\n')}</ul>
              `;

              combinedContent += section + "\n";
            }

            console.log("üöÄ Publishing to LoopedIn...");

            const title = `Release Notes (Last ${days} Days)`;

            await axios.post(
              `https://api.loopedin.io/v1/workspaces/${workspaceId}/updates`,
              {
                title,
                body: combinedContent,
                visibility: "public",
                status: "published"
              },
              {
                headers: {
                  "x-loopedin-key": loopedinApiKey,
                  "Content-Type": "application/json",
                },
              }
            );

            console.log("‚úÖ Release notes published to LoopedIn!");
          }

          run().catch(err => {
            console.error("‚ùå Failed:", err.response?.data || err.message || err);
            process.exit(1);
          });
          EOF
